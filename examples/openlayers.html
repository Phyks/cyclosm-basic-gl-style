<!DOCTYPE html>
<html>
  <head>
    <title>CyclOSM - OpenLayers</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
    <script src="https://unpkg.com/ol-mapbox-style@3.5.0/dist/olms.js"></script>
    <style>
      html, body {
        padding: 0;
        margin: 0;
      }

      #map {
        width: 100%;
        height: 100%;
        position: absolute;
        background: #f8f4f0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      fetch('../style.json').then(response => response.json()).then(
        (style) => {
          // Set URLS, put your access tokens below
          style.sources.openmaptiles.url = 'https://api.mapbox.com/v4/phyks.bai042tw.json?access_token='
          style.glyphs = 'https://free.tilehosting.com/fonts/{fontstack}/{range}.pbf?key='
          style.sprite = 'https://maps.tilehosting.com/styles/bright/sprite'

          // Default view
          var zoom = 10;
          var center = ol.proj.fromLonLat([2.3717, 48.8340]);
          var rotation = 0;

          if (window.location.hash !== '') {
            // try to restore center, zoom-level and rotation from the URL
            var hash = window.location.hash.replace('#map=', '');
            var parts = hash.split('/');
            if (parts.length === 4) {
              zoom = parseInt(parts[0], 10);
              center = [
                parseFloat(parts[1]),
                parseFloat(parts[2])
              ];
              rotation = parseFloat(parts[3]);
            }
          }
          var map = olms.apply('map', style)

          map.setView(new ol.View({
            center: center,
            zoom: zoom,
            rotation: rotation,
          }));

          var shouldUpdate = true;
          var view = map.getView();
          var updatePermalink = function() {
            if (!shouldUpdate) {
              // do not update the URL when the view was changed in the 'popstate' handler
              shouldUpdate = true;
              return;
            }

            var center = view.getCenter();
            var hash = '#map=' +
              view.getZoom() + '/' +
              Math.round(center[0] * 100) / 100 + '/' +
              Math.round(center[1] * 100) / 100 + '/' +
              view.getRotation();
            var state = {
              zoom: view.getZoom(),
              center: view.getCenter(),
              rotation: view.getRotation()
            };
            window.history.pushState(state, 'map', hash);
          };

          map.on('moveend', updatePermalink);

          // restore the view state when navigating through the history, see
          // https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onpopstate
          window.addEventListener('popstate', function(event) {
            if (event.state === null) {
              return;
            }
            map.getView().setCenter(event.state.center);
            map.getView().setZoom(event.state.zoom);
            map.getView().setRotation(event.state.rotation);
            shouldUpdate = false;
          });
        }
      );
    </script>
  </body>
</html>
